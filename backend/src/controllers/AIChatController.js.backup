const express = require('express');
const router = express.Router();
const { requireAuth } = require('../lib/authMiddleware');

// Simple in-memory conversation store for dev/testing.
// Maps userId -> Array<{ role: 'user'|'assistant', content: string, timestamp: string }>
const conversationStore = new Map();

// Simple PII detectors (email + Indian phone numbers)
function detectPIIInText(text) {
  if (!text || typeof text !== 'string') return [];
  const findings = [];
  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
  const phoneRegex = /(?:\+91|91|0)?[6-9]\d{9}/g; // basic India mobile pattern

  const emails = text.match(emailRegex) || [];
  const phones = text.match(phoneRegex) || [];

  for (const e of emails) findings.push({ type: 'email', match: e });
  for (const p of phones) findings.push({ type: 'phone', match: p });

  return findings;
}

function detectPIIInMessages(messages) {
  const allFindings = [];
  if (!messages) return allFindings;
  for (const m of messages) {
    const text = m?.content || m;
    const f = detectPIIInText(text);
    if (f.length) {
      allFindings.push(...f.map(x => ({ ...x, source: text })));
    }
  }
  return allFindings;
}

// AI Chat endpoint
router.post('/chat', requireAuth, async (req, res) => {
  try {
    const { message, caseId, conversationHistory } = req.body;
    
    if (!message) {
      return res.status(400).json({ success: false, error: 'Message is required' });
    }
    
    // In production, integrate with OpenAI/Claude/other AI service
    // For now, return a mock response
    
    const responses = {
      "strengths": "Based on my analysis, your case has several strong points:\n\n1. **Clear Documentation**: You have substantial evidence supporting your claims.\n2. **Legal Precedent**: Similar cases have ruled in favor of plaintiffs in this jurisdiction.\n3. **Timeline**: Your prompt action strengthens your position.\n4. **Witness Testimony**: Multiple witnesses corroborate your account.\n\nI recommend proceeding with settlement negotiations while maintaining this strong position.",
      
      "precedents": "Relevant legal precedents for your case include:\n\n1. **Smith v. Jones (2022)**: Established similar liability standards\n2. **Brown v. County (2021)**: Set damages framework for comparable cases\n3. **State v. Corporation (2020)**: Clarified duty of care requirements\n\nThese precedents generally favor your position and could strengthen settlement negotiations.",
      
      "settlement": "Settlement options to consider:\n\n1. **Full Compensation**: Demand 100% of claimed damages ($50,000)\n2. **Reduced Settlement**: Accept 75% ($37,500) for quicker resolution\n3. **Structured Payment**: Monthly payments over 12-24 months\n4. **Non-Monetary Terms**: Include future preventive measures\n\nGiven the strength of your case, I'd recommend starting with option 1 and being willing to negotiate to option 2.",
      
      "timeline": "Expected timeline for your case:\n\n1. **Discovery Phase**: 2-3 months for evidence exchange\n2. **Mediation**: 1-2 months for settlement discussions\n3. **Trial Preparation**: 2-3 months if settlement fails\n4. **Trial**: 1-2 weeks of court time\n5. **Appeals**: 6-12 months if either party appeals\n\n**Total Estimate**: 6-8 months for settlement, 12-18 months for full trial.\n\nI recommend pursuing settlement to save time and costs.",
      
      "default": `I understand your question about "${message}". Based on the ${caseId ? 'case details' : 'information provided'}, here's my analysis:\n\nYour situation involves important legal considerations that require careful examination. ${conversationHistory && conversationHistory.length > 2 ? 'Building on our previous discussion, ' : ''}I recommend:\n\n1. **Document Everything**: Keep detailed records of all interactions\n2. **Consider Mediation**: Often faster and less costly than litigation\n3. **Know Your Rights**: Familiarize yourself with relevant laws\n4. **Seek Resolution**: Focus on practical solutions\n\nWould you like me to elaborate on any specific aspect?`
    };
    
    // Persist conversation in memory (dev only)
    try {
      const userId = req.user?.sub || req.user?.id || 'anon';
      const history = conversationStore.get(userId) || [];
      history.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
      // merge any provided conversationHistory
      if (Array.isArray(conversationHistory) && conversationHistory.length) {
        for (const h of conversationHistory) {
          if (!h.role || !h.content) continue;
          history.push({ role: h.role, content: h.content, timestamp: new Date().toISOString() });
        }
      }
      // keep last 40 messages
      conversationStore.set(userId, history.slice(-40));
    } catch (e) {
      // don't fail if store update fails
      console.warn('Conversation store update failed', e.message || e);
    }

    // Simple keyword matching for demo
    const lowerMessage = message.toLowerCase();
    let response;
    
    if (lowerMessage.includes('strength')) {
      response = responses.strengths;
    } else if (lowerMessage.includes('precedent') || lowerMessage.includes('legal')) {
      response = responses.precedents;
    } else if (lowerMessage.includes('settlement') || lowerMessage.includes('option')) {
      response = responses.settlement;
    } else if (lowerMessage.includes('long') || lowerMessage.includes('timeline') || lowerMessage.includes('time')) {
      response = responses.timeline;
    } else {
      response = responses.default;
    }
    
    // Save assistant response to conversation store
    try {
      const userId = req.user?.sub || req.user?.id || 'anon';
      const history = conversationStore.get(userId) || [];
      history.push({ role: 'assistant', content: response, timestamp: new Date().toISOString() });
      conversationStore.set(userId, history.slice(-40));
    } catch (e) {
      // ignore
    }

    res.json({
      success: true,
      data: {
        response,
        confidence: 0.87,
        sources: [
          'Legal precedent database',
          'Case law analysis',
          'Settlement statistics'
        ]
      }
    });
    
  } catch (error) {
    console.error('Error in AI chat:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// Streaming chat endpoint (SSE) with lightweight PII detection.
// POST /api/ai/stream
router.post('/stream', requireAuth, async (req, res) => {
  try {
    const { message, caseId, conversationHistory, allowPII } = req.body || {};

    if (!message) {
      return res.status(400).json({ success: false, error: 'Message is required' });
    }

    // Detect PII across the user message and conversation history
    const findings = detectPIIInMessages([message].concat(conversationHistory || []));
    if (findings.length && !allowPII) {
      return res.status(400).json({ success: false, error: 'PII_DETECTED', data: { findings } });
    }

    // Check if query is legal/judiciary related
    const lowerMessage = (message || '').toLowerCase();
    
    // Legal/judiciary keywords
    const legalKeywords = [
      'law', 'legal', 'court', 'judge', 'judiciary', 'case', 'dispute', 'contract', 'agreement',
      'constitution', 'article', 'section', 'act', 'rights', 'lawyer', 'advocate', 'attorney',
      'settlement', 'mediation', 'arbitration', 'litigation', 'suit', 'petition', 'appeal',
      'evidence', 'witness', 'testimony', 'verdict', 'judgment', 'ruling', 'decree',
      'consumer', 'complaint', 'compensation', 'damages', 'breach', 'liability', 'negligence',
      'injunction', 'bail', 'custody', 'property', 'tenant', 'landlord', 'divorce', 'marriage',
      'criminal', 'civil', 'writ', 'pil', 'fir', 'police', 'ipc', 'crpc', 'cpc',
      'supreme court', 'high court', 'district court', 'magistrate', 'tribunal',
      'legal notice', 'legal advice', 'legal right', 'legal help', 'legal issue',
      'file a case', 'file complaint', 'sue', 'defamation', 'cheque bounce', 'fraud',
      'analyze', 'review my case', 'my situation', 'help me', 'what should i do',
      'document', 'pdf', 'evidence analysis', 'case analysis'
    ];
    
    // Check if message contains any legal keywords or is a follow-up in conversation
    const isLegalQuery = legalKeywords.some(keyword => lowerMessage.includes(keyword));
    const hasConversationHistory = conversationHistory && conversationHistory.length > 0;
    
    // If not a legal query and no conversation history, reject
    if (!isLegalQuery && !hasConversationHistory) {
      // Double-check: allow common greeting/intro phrases
      const allowedGreetings = ['hello', 'hi', 'hey', 'namaste', 'good', 'thank'];
      const isGreeting = allowedGreetings.some(g => lowerMessage.includes(g));
      
      if (!isGreeting) {
        const offTopicResponse = `I apologize, but I can only assist with legal and judiciary-related matters.\n\nI specialize in:\nâ€¢ Indian law and constitutional questions\nâ€¢ Court procedures and legal processes\nâ€¢ Dispute resolution and case analysis\nâ€¢ Legal rights and obligations\nâ€¢ Settlement and mediation strategies\n\nPlease ask a question related to law, legal disputes, or the Indian judiciary system, and I'll be happy to help! ðŸ“œâš–ï¸`;
        
        // Stream the off-topic response
        res.writeHead(200, {
          'Content-Type': 'text/event-stream',
          'Cache-Control': 'no-cache',
          Connection: 'keep-alive'
        });
        
        res.write(`data: ${offTopicResponse.replace(/\n/g, '\\n')}\n\n`);
        res.write('event: done\n\n');
        res.end();
        return;
      }
    }

    // Reuse same lightweight responder logic from /chat
    let responseText = '';
    
    // Enhanced Indian Legal Analysis System Prompt
    const systemContext = `You are an AI Legal Analysis Companion EXCLUSIVELY focused on Indian law, judiciary, and legal disputes. 

STRICT SCOPE:
- ONLY answer questions about law, legal matters, courts, judiciary, and dispute resolution
- REFUSE politely if asked about general topics, entertainment, technology, or non-legal subjects
- Focus on Indian legal system: Constitution, statutes, court procedures, legal rights

Your capabilities include:

1. CONSTITUTIONAL ANALYSIS: Reference Constitution of India, fundamental rights (Articles 12-35), directive principles
2. INDIAN LEGAL FRAMEWORK: Consumer Protection Act 2019, Contract Act 1872, CPC 1908, Evidence Act 1872
3. DISPUTE RESOLUTION: Settlement options, mediation, arbitration, Lok Adalat, court procedures
4. LEGAL EDUCATION: Explain legal concepts clearly, avoid jargon, empower users with legal knowledge
5. CASE-SPECIFIC GUIDANCE: Provide practical, actionable legal advice based on user's situation

Response guidelines:
- Be concise and directly answer the legal question
- Avoid repetitive information and unnecessary elaboration
- Cite specific laws, articles, sections when relevant
- Provide practical next steps the user can take
- If unclear, ask for case-specific details rather than giving generic advice`;

    // Enhanced responses with Indian legal context
    const responses = {
      "constitution": `ðŸ“œ **Constitutional Analysis of Your Dispute**\n\nUnder the Constitution of India:\n\n**Fundamental Rights (Articles 12-35):**\nâ€¢ Article 21: Right to Life and Personal Liberty - Your dispute may invoke constitutional protections\nâ€¢ Article 19: Freedom of Speech and Expression - Relevant if communication/contract issues exist\nâ€¢ Article 14: Equality before Law - Ensures fair treatment in dispute resolution\n\n**Legal Remedies:**\nâ€¢ Constitutional Remedies under Article 32/226 (if fundamental rights violated)\nâ€¢ Civil remedies under relevant statutes (Consumer Protection Act, Contract Act)\nâ€¢ Alternative Dispute Resolution (ADR) under Section 89 CPC\n\n**Recommended Approach:**\n1. First attempt settlement/mediation under ADR mechanisms\n2. File consumer complaint if product/service dispute\n3. Civil suit if contractual breach\n4. Constitutional petition only if fundamental rights at stake\n\nWould you like me to analyze which constitutional provision applies to your specific situation?`,
      
      "rights": `âš–ï¸ **Your Legal Rights Under Indian Law**\n\nBased on your dispute, you have the following rights:\n\n**Under Consumer Protection Act 2019:**\nâ€¢ Right to be informed about quality, quantity, price\nâ€¢ Right to be protected against unfair trade practices\nâ€¢ Right to seek redressal before Consumer Forum (District/State/National)\nâ€¢ Right to compensation for deficiency in service/defective goods\n\n**Under Contract Act 1872:**\nâ€¢ Right to enforce valid contracts (Section 10)\nâ€¢ Right to compensation for breach (Section 73)\nâ€¢ Right to rescind contract if induced by fraud/misrepresentation (Section 19)\n\n**Constitutional Rights:**\nâ€¢ Right to justice under Article 39A\nâ€¢ Right to legal aid if unable to afford (Legal Services Authorities Act 1987)\n\n**Your Options:**\n1. Demand specific performance of contract\n2. Claim damages for breach\n3. File consumer complaint (simple, fast, no court fee)\n4. Approach civil court if claim exceeds â‚¹1 crore\n\nWhich specific right would you like me to explain in detail?`,
      
      "settlement": `ðŸ¤ **Fair Settlement Options Under Indian Law**\n\nConsidering legal principles and practical resolution:\n\n**Option 1: Mediation (Recommended)**\nâ€¢ File application under Section 89 CPC for court-referred mediation\nâ€¢ Neutral mediator facilitates discussion\nâ€¢ Legally binding settlement if both parties agree\nâ€¢ Average time: 2-3 months\nâ€¢ Cost: Minimal (â‚¹1,000-5,000)\n\n**Option 2: Lok Adalat (People's Court)**\nâ€¢ Free legal service for disputes up to â‚¹20 lakhs\nâ€¢ Voluntary, speedy resolution\nâ€¢ Award has force of civil court decree\nâ€¢ No appeal against Lok Adalat decision\n\n**Option 3: Negotiated Settlement**\nâ€¢ Direct discussion with opposing party\nâ€¢ Compensation amount: [Based on your case specifics]\nâ€¢ Payment terms: Lump sum or installments\nâ€¢ Include non-monetary terms if needed\n\n**Option 4: Consumer Forum Filing**\nâ€¢ If product/service dispute\nâ€¢ No lawyer required (can self-represent)\nâ€¢ Decision within 3-5 months typically\n\n**Recommended Settlement Framework:**\n1. Establish liability (who is at fault)\n2. Quantify damages (financial + mental agony compensation)\n3. Propose 60-40 or 70-30 compromise\n4. Draft settlement deed on â‚¹100 stamp paper\n5. Execute before witnesses or get notarized\n\nWhich settlement mechanism would you prefer to explore?`,
      
      "analysis": `ðŸ” **Legal Analysis Under Indian Jurisprudence**\n\n**Case Classification:**\nBased on your description, this appears to be a [Civil/Consumer/Contractual] dispute falling under:\nâ€¢ Primary Statute: [Consumer Protection Act 2019 / Indian Contract Act 1872]\nâ€¢ Jurisdiction: [Consumer Forum / Civil Court / Arbitration]\n\n**Legal Strengths:**\n1. **Documentary Evidence**: Written agreements/receipts strengthen your position\n2. **Legal Precedents**: Indian courts consistently uphold [relevant principle]\n3. **Statutory Protection**: Consumer forums favor genuine complainants\n4. **Timeline**: Prompt action indicates seriousness\n\n**Potential Challenges:**\n1. **Burden of Proof**: Under Indian Evidence Act, you must prove your claims (Section 101-102)\n2. **Limitation Period**: Must file within time limits (Consumer Act: 2 years; Contract: 3 years)\n3. **Opponent's Defense**: They may claim [common defenses]\n\n**Constitutional Perspective:**\nArticle 39A (Equal Justice and Free Legal Aid) ensures access to justice. If economically weak, you can seek free legal aid from District Legal Services Authority.\n\n**Recommended Legal Strategy:**\n1. Send legal notice under Section 138 (if cheque bounce) or general notice\n2. Give 15-30 days for response\n3. If no response, file appropriate complaint/suit\n4. Simultaneously explore settlement\n\n**Likely Outcome:**\nBased on similar cases in Indian courts, success probability: [High/Medium] if you have proper documentation.\n\nShall I help draft a legal notice or analyze specific evidence?`,
      
      "default": `ðŸ‡®ðŸ‡³ **AI Legal Analysis - Indian Law Perspective**\n\nNamaste! I've analyzed your query: "${message}"\n\n**Legal Framework:**\nUnder Indian law, your situation requires examination of:\nâ€¢ Relevant statutes and their applicability\nâ€¢ Constitutional provisions protecting your rights\nâ€¢ Established legal precedents from Indian courts\nâ€¢ Available dispute resolution mechanisms\n\n**Key Considerations:**\n1. **Legal Basis**: Which law governs your dispute\n2. **Jurisdiction**: Appropriate forum (Consumer Court/Civil Court/Arbitration)\n3. **Time Limits**: Statutory limitation periods\n4. **Evidence**: Documents needed to prove your case\n\n**Your Rights:**\nAs an Indian citizen, you have:\nâ€¢ Right to access justice (Article 39A, Constitution)\nâ€¢ Right to fair hearing and due process\nâ€¢ Right to legal representation (or self-representation)\nâ€¢ Right to appeal if dissatisfied with decision\n\n**Recommended Actions:**\n1. Gather all documentary evidence (agreements, receipts, communications)\n2. Send legal notice to opposing party (gives them chance to settle)\n3. Consult District Legal Services Authority if you need free legal aid\n4. Choose appropriate forum based on claim amount and nature\n\n**Settlement vs Litigation:**\nâ€¢ Settlement: Faster (2-4 months), cheaper, preserve relationships\nâ€¢ Litigation: Formal, longer (1-3 years), binding court order\n\nI recommend attempting settlement first through mediation/Lok Adalat.\n\n${conversationHistory && conversationHistory.length > 2 ? 'Based on our previous discussion, ' : ''}Would you like me to:\na) Analyze specific legal provisions applicable to your case\nb) Suggest settlement terms\nc) Explain the litigation process\nd) Draft a legal notice template\n\nPlease share more case details for specific constitutional/legal analysis.`
    };

    if (lowerMessage.includes('constitution') || lowerMessage.includes('article') || lowerMessage.includes('fundamental right')) {
      responseText = responses.constitution;
    } else if (lowerMessage.includes('right') || lowerMessage.includes('what can i do') || lowerMessage.includes('my rights')) {
      responseText = responses.rights;
    } else if (lowerMessage.includes('settlement') || lowerMessage.includes('settle') || lowerMessage.includes('option') || lowerMessage.includes('mediation')) {
      responseText = responses.settlement;
    } else if (lowerMessage.includes('analyz') || lowerMessage.includes('strength') || lowerMessage.includes('case') || lowerMessage.includes('situation')) {
      responseText = responses.analysis;
    } else {
      responseText = responses.default;
    }

    // Persist conversation in memory (dev only)
    try {
      const userId = req.user?.sub || req.user?.id || 'anon';
      const history = conversationStore.get(userId) || [];
      history.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
      history.push({ role: 'assistant', content: responseText, timestamp: new Date().toISOString() });
      conversationStore.set(userId, history.slice(-40));
    } catch (e) {
      // don't fail if store update fails
      console.warn('Conversation store update failed', e.message || e);
    }

    // Stream the response using SSE
    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      Connection: 'keep-alive'
    });

    // Helper to sleep
    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    // Break responseText into manageable chunks (by sentences or by length)
    const chunks = [];
    // split by sentences heuristically
    const sentenceParts = responseText.split(/(?<=[\.\?\!])\s+/);
    for (const s of sentenceParts) {
      if (!s) continue;
      // further split long sentences
      if (s.length > 300) {
        for (let i = 0; i < s.length; i += 200) {
          chunks.push(s.slice(i, i + 200));
        }
      } else {
        chunks.push(s);
      }
    }

    // Send chunks with a small delay to emulate streaming tokens
    (async () => {
      for (const chunk of chunks) {
        // SSE data: <chunk>\n\n
        try {
          res.write(`data: ${chunk.replace(/\n/g, '\\n')}\n\n`);
        } catch (e) {
          // client disconnected
          break;
        }
        await sleep(60);
      }

      // final event
      try {
        res.write('event: done\n\n');
      } catch (e) {
        // ignore
      }
      try {
        res.end();
      } catch (e) {
        // ignore
      }
    })();

  } catch (error) {
    console.error('Error in AI chat stream:', error);
    // If headers already sent, just end
    if (!res.headersSent) {
      res.status(500).json({ success: false, error: error.message });
    } else {
      try { res.end(); } catch (e) {}
    }
  }
});

// Analyze evidence (used by Evidence Upload component)
router.post('/analyze-evidence', requireAuth, async (req, res) => {
  try {
    const { evidenceId, fileUrl, fileName } = req.body;
    
    // In production, integrate with AI service for actual analysis
    // For now, return mock analysis
    
    const analysisResults = {
      relevanceScore: Math.floor(Math.random() * 30) + 70, // 70-100
      summary: `Document "${fileName}" contains important information relevant to the case. Key points have been extracted and categorized.`,
      keyPoints: [
        'Document establishes timeline of events',
        'Contains statements from involved parties',
        'Provides supporting evidence for claims',
        'Identifies potential witnesses'
      ],
      extractedText: `This is a sample of extracted text from ${fileName}. In production, this would contain actual OCR results and document content analysis.`,
      categories: ['Evidence', 'Testimony', 'Documentation'],
      confidence: 0.92
    };
    
    res.json({
      success: true,
      data: analysisResults
    });
    
  } catch (error) {
    console.error('Error analyzing evidence:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

module.exports = router;
